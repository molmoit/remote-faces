{"version":3,"sources":["hooks/useVideoShare.ts","components/VideoShare.tsx"],"names":["isVideoTrack","track","a","kind","isVideoTrackFaceSize","isFaceSize","Video","React","memo","nickname","stream","videoRef","useRef","useEffect","current","srcObject","className","ref","autoPlay","muted","VideoShare","roomId","userId","videoDevices","useVideoDevices","useState","videoDeviceId","setVideoDeviceId","enabled","setEnabled","videoStream","setVideoStream","videoStreamMap","setVideoStreamMap","cleanupFns","forEach","fn","onTrack","useCallback","info","prev","MediaStream","onended","addEventListener","push","removeEventListener","useRoomMedia","addTrack","removeTrack","dispose","getVideoStream","result","getVideoTracks","useVideoShare","nicknameMap","useNicknameMap","numOfVideos","Object","values","filter","x","length","value","onChange","e","target","map","videoDevice","key","deviceId","label","type","onClick","style","gridTemplateColumns","Math","ceil","sqrt","keys","screenUserId"],"mappings":"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","file":"static/js/9.f540af62.chunk.js","sourcesContent":["import { useCallback, useEffect, useState, useRef } from \"react\";\n\nimport { getVideoStream, isVideoTrackFaceSize } from \"../media/video\";\nimport { useRoomMedia } from \"./useRoom\";\n\nconst isVideoTrack = async (track: MediaStreamTrack) => {\n  if (track.kind !== \"video\") return false;\n  const isFaceSize = await isVideoTrackFaceSize(track);\n  return !isFaceSize;\n};\n\nexport const useVideoShare = (\n  roomId: string,\n  userId: string,\n  enabled: boolean,\n  setEnabled: (enabled: boolean) => void,\n  videoDeviceId?: string\n) => {\n  const [videoStream, setVideoStream] = useState<MediaStream | null>(null);\n  const [videoStreamMap, setVideoStreamMap] = useState<{\n    [userId: string]: MediaStream | null;\n  }>({});\n\n  type CleanupFn = () => void;\n  const cleanupFns = useRef<CleanupFn[]>([]);\n  useEffect(() => {\n    const cleanup = () => {\n      cleanupFns.current.forEach((fn) => fn());\n    };\n    return cleanup;\n  }, []);\n\n  const onTrack = useCallback(async (track, info) => {\n    if (!(await isVideoTrack(track))) return;\n    setVideoStreamMap((prev) => ({\n      ...prev,\n      [info.userId]: new MediaStream([track]),\n    }));\n    const onended = () => {\n      setVideoStreamMap((prev) => ({\n        ...prev,\n        [info.userId]: null,\n      }));\n    };\n    track.addEventListener(\"ended\", onended);\n    cleanupFns.current.push(() => {\n      track.removeEventListener(\"ended\", onended);\n    });\n  }, []);\n\n  const { addTrack, removeTrack } = useRoomMedia(\n    roomId,\n    userId,\n    onTrack,\n    \"cameraVideo\"\n  );\n\n  useEffect(() => {\n    let dispose: (() => void) | null = null;\n    if (enabled && addTrack && removeTrack) {\n      (async () => {\n        const result = await getVideoStream(videoDeviceId);\n        const [track] = result.stream.getVideoTracks();\n        addTrack(track);\n        setVideoStream(result.stream);\n        dispose = () => {\n          removeTrack(track);\n          result.dispose();\n          setVideoStream(null);\n          setEnabled(false);\n        };\n        track.addEventListener(\"ended\", () => {\n          if (dispose) dispose();\n          dispose = null;\n        });\n      })();\n    }\n    return () => {\n      if (dispose) dispose();\n    };\n  }, [roomId, videoDeviceId, enabled, setEnabled, addTrack, removeTrack]);\n\n  return { videoStream, videoStreamMap };\n};\n","import React, { useState, useRef, useEffect } from \"react\";\n\nimport \"./VideoShare.css\";\nimport { useVideoShare } from \"../hooks/useVideoShare\";\nimport { useVideoDevices } from \"../hooks/useAvailableDevices\";\nimport { useNicknameMap } from \"../hooks/useNicknameMap\";\n\nconst Video = React.memo<{\n  nickname: string;\n  stream: MediaStream;\n}>(({ nickname, stream }) => {\n  const videoRef = useRef<HTMLVideoElement>(null);\n  useEffect(() => {\n    if (stream && videoRef.current) {\n      videoRef.current.srcObject = stream;\n    }\n  }, [stream]);\n  return (\n    <div>\n      <div className=\"VideoShare-nickname\">{nickname}</div>\n      <video className=\"VideoShare-video\" ref={videoRef} autoPlay muted />\n    </div>\n  );\n});\n\nexport const VideoShare = React.memo<{\n  roomId: string;\n  userId: string;\n  nickname: string;\n}>(({ roomId, userId, nickname }) => {\n  const videoDevices = useVideoDevices();\n  const [videoDeviceId, setVideoDeviceId] = useState<string>();\n  const [enabled, setEnabled] = useState(false);\n  const { videoStream, videoStreamMap } = useVideoShare(\n    roomId,\n    userId,\n    enabled,\n    setEnabled,\n    videoDeviceId\n  );\n  const nicknameMap = useNicknameMap(roomId, userId);\n  const numOfVideos =\n    (videoStream ? 1 : 0) +\n    Object.values(videoStreamMap).filter((x) => x).length;\n\n  return (\n    <div className=\"VideoShare-container\">\n      <div>\n        Select Camera:{\" \"}\n        <select\n          value={videoDeviceId}\n          onChange={(e) => setVideoDeviceId(e.target.value)}\n        >\n          {videoDevices.map((videoDevice) => (\n            <option key={videoDevice.deviceId} value={videoDevice.deviceId}>\n              {videoDevice.label}\n            </option>\n          ))}\n        </select>\n      </div>\n      <button type=\"button\" onClick={() => setEnabled(!enabled)}>\n        {enabled ? \"Stop video share\" : \"Start video share\"}\n      </button>\n      <div\n        className=\"VideoShare-body\"\n        style={{\n          gridTemplateColumns: `repeat(${Math.ceil(\n            Math.sqrt(numOfVideos)\n          )}, 1fr)`,\n        }}\n      >\n        {videoStream && <Video nickname={nickname} stream={videoStream} />}\n        {Object.keys(videoStreamMap).map((screenUserId) => {\n          const stream = videoStreamMap[screenUserId];\n          if (!stream) return null;\n          return (\n            <Video\n              key={screenUserId}\n              nickname={nicknameMap[screenUserId] || \"No Name\"}\n              stream={stream}\n            />\n          );\n        })}\n      </div>\n    </div>\n  );\n});\n\nexport default VideoShare;\n"],"sourceRoot":""}